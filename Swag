# Filter for the most recent year and calculate the adjusted business day
most_recent_year = input_df['dt2_report'].dt.year.max()
recent_year_df = input_df[input_df['dt2_report'].dt.year == most_recent_year].copy()

# Sort the dataframe by date to ensure proper sequential processing
recent_year_df.sort_values('dt2_report', inplace=True)

# Initialize the adjusted business day for the first date of the year
recent_year_df['adjusted_business_day'] = 1

# Variable to keep track of the last adjusted business day
last_adj_bd = 1

for month in range(1, 13):
    # Get the data for the current month
    month_data = recent_year_df[recent_year_df['dt2_report'].dt.month == month]
    
    # If there's no data for the month, skip to the next month
    if month_data.empty:
        continue

    # Get the maximum business day from the previous year for the current month
    max_bd_previous_year = get_max_bd_previous_year(month_data.iloc[-1], input_df)

    # Iterate through the days of the month to adjust business days
    for idx, row in month_data.iterrows():
        if idx == month_data.index[0] and month != 1:
            # For the first day of new months (except January), start from the next of last adjusted business day
            recent_year_df.at[idx, 'adjusted_business_day'] = last_adj_bd + 1
            last_adj_bd += 1
        elif idx != month_data.index[-1]:
            # For days other than the last, increment the adjusted business day
            recent_year_df.at[idx, 'adjusted_business_day'] = last_adj_bd + 1
            last_adj_bd += 1
        else:
            # For the last day of the month, adjust based on the maximum business day of the same month from the previous year
            if max_bd_previous_year and last_adj_bd < max_bd_previous_year:
                recent_year_df.at[idx, 'adjusted_business_day'] = max_bd_previous_year
                last_adj_bd = max_bd_previous_year
            else:
                # If the last adjusted business day is already equal or greater than the max from the previous year, just increment
                recent_year_df.at[idx, 'adjusted_business_day'] = last_adj_bd + 1
                last_adj_bd += 1

# Merge the adjusted business days back to the input dataframe
input_df = input_df.merge(recent_year_df[['dt2_report', 'adjusted_business_day']], 
                          on='dt2_report', 
                          how='left')

# Print out the adjusted business days to verify the results
print(input_df[input_df['dt2_report'].dt.year == most_recent_year].head(60))
