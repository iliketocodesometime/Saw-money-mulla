Option Explicit

Sub GeneratePPTsPerDirector()

    '----- [1] PREPARE WORKSHEETS -----
    Dim wsPipeline As Worksheet, wsSales As Worksheet
    On Error Resume Next
    Set wsPipeline = ThisWorkbook.Sheets("New Plan Pipeline")
    Set wsSales = ThisWorkbook.Sheets("New Plan Sales")
    On Error GoTo 0
    
    If wsPipeline Is Nothing Or wsSales Is Nothing Then
        MsgBox "Missing required sheets. Aborting."
        Exit Sub
    End If
    
    ' Create hidden "Helper" if it doesn't exist (for the Think-Cell data)
    Dim wsHelper As Worksheet
    On Error Resume Next
    Set wsHelper = ThisWorkbook.Sheets("Helper")
    On Error GoTo 0
    If wsHelper Is Nothing Then
        Set wsHelper = ThisWorkbook.Worksheets.Add
        wsHelper.Name = "Helper"
        wsHelper.Visible = xlSheetHidden
    End If
    
    '----- [2] GATHER DIRECTORS FROM "New Plan Pipeline" -----
    Dim lastRow As Long
    lastRow = wsPipeline.Cells(wsPipeline.Rows.Count, "A").End(xlUp).Row
    
    Dim dictDirs As Object
    Set dictDirs = CreateObject("Scripting.Dictionary")
    
    Dim i As Long
    Dim dirName As String
    For i = 2 To lastRow
        dirName = Trim(wsPipeline.Cells(i, "B").Value)
        If dirName <> "" Then
            If Not dictDirs.Exists(dirName) Then dictDirs.Add dirName, dirName
        End If
    Next i
    
    '----- [3] PRE-COMPUTE TOTALS ACROSS ALL DIRECTORS FROM "New Plan Sales" -----
    Dim lastRowSales As Long
    lastRowSales = wsSales.Cells(wsSales.Rows.Count, "A").End(xlUp).Row
    
    Dim totalAllCount As Long
    Dim totalAllAUM As Double
    Dim totalAllParticipants As Long
    
    ' Columns in wsSales (adjust if needed):
    '   A: Account Name
    '   C: Director
    '   D: Estimated Participants
    '   F: Total AUM (converted)
    For i = 2 To lastRowSales
        If Trim(wsSales.Cells(i, "A").Value) <> "" Then
            totalAllCount = totalAllCount + 1
        End If
        totalAllAUM = totalAllAUM + wsSales.Cells(i, "F").Value
        totalAllParticipants = totalAllParticipants + wsSales.Cells(i, "D").Value
    Next i
    
    '----- [4] PREPARE THINK-CELL AND POWERPOINT REFERENCES -----
    Dim tcXlAddIn As Object
    On Error Resume Next
    Set tcXlAddIn = Application.COMAddIns("thinkcell.addin").Object
    On Error GoTo 0
    
    ' If you don't have Think-Cell installed, tcXlAddIn will be Nothing.
    ' We'll proceed, but skip Think-Cell updates if it's not found.
    
    Dim ppApp As PowerPoint.Application
    Set ppApp = New PowerPoint.Application
    
    '----- [5] STAGE LABELS -----
    Dim stageLabels As Variant
    stageLabels = Array( _
        "Active Pursuit", _
        "Shortlisted / Decision Pending", _
        "Verbal Agreement", _
        "Contract Negotiation" _
    )
    
    '----- [6] LOOP THROUGH EACH DIRECTOR AND CREATE A PPT -----
    Dim director As Variant
    For Each director In dictDirs.Keys
        
        '=== (a) RESET ARRAYS FOR THINK-CELL CHART1 ===
        Dim countStages(1 To 4) As Long
        countStages(1) = 0: countStages(2) = 0
        countStages(3) = 0: countStages(4) = 0
        
        '=== (b) ARRAYS FOR NATIVE EXCEL CHART & STATS ===
        Dim sumAUM(1 To 4) As Double
        Dim sumParticipants(1 To 4) As Long
        
        '=== (c) LOOP THROUGH "New Plan Pipeline" ROWS ===
        For i = 2 To lastRow
            If Trim(wsPipeline.Cells(i, "B").Value) = director Then
                Dim stg As String
                stg = Trim(wsPipeline.Cells(i, "E").Value)
                
                Select Case stg
                    Case "Active Pursuit"
                        countStages(1) = countStages(1) + 1
                        sumAUM(1) = sumAUM(1) + wsPipeline.Cells(i, "C").Value
                        sumParticipants(1) = sumParticipants(1) + wsPipeline.Cells(i, "D").Value
                        
                    Case "Shortlisted / Decision Pending"
                        countStages(2) = countStages(2) + 1
                        sumAUM(2) = sumAUM(2) + wsPipeline.Cells(i, "C").Value
                        sumParticipants(2) = sumParticipants(2) + wsPipeline.Cells(i, "D").Value
                        
                    Case "Verbal Agreement"
                        countStages(3) = countStages(3) + 1
                        sumAUM(3) = sumAUM(3) + wsPipeline.Cells(i, "C").Value
                        sumParticipants(3) = sumParticipants(3) + wsPipeline.Cells(i, "D").Value
                        
                    Case "Contract Negotiation"
                        countStages(4) = countStages(4) + 1
                        sumAUM(4) = sumAUM(4) + wsPipeline.Cells(i, "C").Value
                        sumParticipants(4) = sumParticipants(4) + wsPipeline.Cells(i, "D").Value
                End Select
            End If
        Next i
        
        '=== (d) FILL HELPER FOR THINK-CELL "Chart1" (rows 1..3) ===
        If Not tcXlAddIn Is Nothing Then
            With wsHelper
                ' Row 1: Stage labels
                .Range("A1").Value = ""
                .Range("B1").Value = stageLabels(0)
                .Range("C1").Value = stageLabels(1)
                .Range("D1").Value = stageLabels(2)
                .Range("E1").Value = stageLabels(3)
                
                ' Row 3: # in stage (counts)
                .Range("A3").Value = ""
                .Range("B3").Value = countStages(1)
                .Range("C3").Value = countStages(2)
                .Range("D3").Value = countStages(3)
                .Range("E3").Value = countStages(4)
            End With
        End If
        
        '=== (e) DIRECTOR-SPECIFIC "NEW PLAN SALES" DATA (FOR TABLE 5) ===
        Dim directorCount As Long
        Dim directorAUM As Double
        Dim directorParticipants As Long
        
        directorCount = 0
        directorAUM = 0
        directorParticipants = 0
        
        For i = 2 To lastRowSales
            If Trim(wsSales.Cells(i, "C").Value) = director Then
                If Trim(wsSales.Cells(i, "A").Value) <> "" Then
                    directorCount = directorCount + 1
                End If
                directorAUM = directorAUM + wsSales.Cells(i, "F").Value
                directorParticipants = directorParticipants + wsSales.Cells(i, "D").Value
            End If
        Next i
        
        '=== (f) OPEN THE POWERPOINT TEMPLATE (invisible) ===
        Dim pres As PowerPoint.Presentation
        Set pres = ppApp.Presentations.Open( _
            Filename:="C:\TemplateFolder\template1.pptx", _
            WithWindow:=msoFalse)
        
        '=== (g) UPDATE THINK-CELL Chart1 (if think-cell is installed) ===
        If Not tcXlAddIn Is Nothing Then
            Dim rngData As Range
            Set rngData = wsHelper.Range("A1:E3")
            tcXlAddIn.UpdateChart pres.Slides(2), "Chart1", rngData, False
        End If
        
        '=== (h) SLIDE 1: DIRECTOR & QUARTER ===
        Dim currentQuarter As String
        currentQuarter = "Q" & CStr(Int((Month(Date) - 1) / 3 + 1)) & " " & Year(Date)
        
        With pres.Slides(1)
            .Shapes("Title").TextFrame.TextRange.Text = director
            .Shapes("Quarter").TextFrame.TextRange.Text = currentQuarter
        End With
        
        '=== (i) SLIDE 2 TABLE "TABLE 5" ===
        Dim shpTable As PowerPoint.Shape
        Set shpTable = pres.Slides(2).Shapes("Table 5")
        
        ' Row2: count of accounts, total count, percent
        shpTable.Table.Cell(2, 2).Shape.TextFrame.TextRange.Text = CStr(directorCount)
        shpTable.Table.Cell(2, 3).Shape.TextFrame.TextRange.Text = CStr(totalAllCount)
        If totalAllCount > 0 Then
            shpTable.Table.Cell(2, 4).Shape.TextFrame.TextRange.Text = _
                Format(directorCount / totalAllCount, "0.0%")
        Else
            shpTable.Table.Cell(2, 4).Shape.TextFrame.TextRange.Text = "N/A"
        End If
        
        ' Row3: total AUM, total AUM all directors, percent
        shpTable.Table.Cell(3, 2).Shape.TextFrame.TextRange.Text = _
            Format(directorAUM / 1E9, "$0.00") & "B"
        shpTable.Table.Cell(3, 3).Shape.TextFrame.TextRange.Text = _
            Format(totalAllAUM / 1E9, "$0.00") & "B"
        If totalAllAUM > 0 Then
            shpTable.Table.Cell(3, 4).Shape.TextFrame.TextRange.Text = _
                Format(directorAUM / totalAllAUM, "0.0%")
        Else
            shpTable.Table.Cell(3, 4).Shape.TextFrame.TextRange.Text = "N/A"
        End If
        
        ' Row4: participants, total participants, percent
        shpTable.Table.Cell(4, 2).Shape.TextFrame.TextRange.Text = CStr(directorParticipants)
        shpTable.Table.Cell(4, 3).Shape.TextFrame.TextRange.Text = CStr(totalAllParticipants)
        If totalAllParticipants > 0 Then
            shpTable.Table.Cell(4, 4).Shape.TextFrame.TextRange.Text = _
                Format(directorParticipants / totalAllParticipants, "0.0%")
        Else
            shpTable.Table.Cell(4, 4).Shape.TextFrame.TextRange.Text = "N/A"
        End If
        
        '=== (j) SLIDE 2: UPDATE THE NATIVE EXCEL CHART "Chart 13" ===
        '   We'll write the stage breakdown (# in Stage, AUM, Participants) 
        '   plus a Grand Total row directly into the chart's embedded workbook.
        Dim shpChart As PowerPoint.Shape
        On Error Resume Next
        Set shpChart = pres.Slides(2).Shapes("Chart 13")
        On Error GoTo 0
        
        If Not shpChart Is Nothing Then
            If shpChart.HasChart Then
                Dim ppChart As PowerPoint.Chart
                Set ppChart = shpChart.Chart
                
                ' Activate the embedded Excel workbook
                ppChart.ChartData.Activate
                
                Dim wbChart As Excel.Workbook
                Set wbChart = ppChart.ChartData.Workbook
                
                Dim wsChart As Excel.Worksheet
                ' Often the default is Worksheet(1), but adjust if needed
                Set wsChart = wbChart.Worksheets(1)
                
                ' Clear or overwrite relevant cells; below is just an example layout:
                wsChart.Range("A1:D1").Value = Array("Stage", "# in Stage", "Estimated AUM", "Est. Participants")
                
                ' Row 2: Active Pursuit
                wsChart.Range("A2").Value = stageLabels(0)
                wsChart.Range("B2").Value = countStages(1)
                wsChart.Range("C2").Value = sumAUM(1)
                wsChart.Range("D2").Value = sumParticipants(1)
                
                ' Row 3: Shortlisted
                wsChart.Range("A3").Value = stageLabels(1)
                wsChart.Range("B3").Value = countStages(2)
                wsChart.Range("C3").Value = sumAUM(2)
                wsChart.Range("D3").Value = sumParticipants(2)
                
                ' Row 4: Verbal Agreement
                wsChart.Range("A4").Value = stageLabels(2)
                wsChart.Range("B4").Value = countStages(3)
                wsChart.Range("C4").Value = sumAUM(3)
                wsChart.Range("D4").Value = sumParticipants(3)
                
                ' Row 5: Contract Negotiation
                wsChart.Range("A5").Value = stageLabels(3)
                wsChart.Range("B5").Value = countStages(4)
                wsChart.Range("C5").Value = sumAUM(4)
                wsChart.Range("D5").Value = sumParticipants(4)
                
                ' Row 6: Grand Total
                wsChart.Range("A6").Value = "Grand Total"
                wsChart.Range("B6").Formula = "=SUM(B2:B5)"
                wsChart.Range("C6").Formula = "=SUM(C2:C5)"
                wsChart.Range("D6").Formula = "=SUM(D2:D5)"
                
                ' Optionally refresh
                ppChart.Refresh
                ' Or ppChart.Update
            End If
        End If
        
        '=== (k) SAVE & CLOSE THIS PPT ===
        pres.SaveAs "C:\OutputPPTs\" & director & "_Pipeline.pptx"
        pres.Close
    Next director
    
    '----- [7] CLEAN UP -----
    ppApp.Quit
    MsgBox "All PowerPoints generated successfully."

End Sub
