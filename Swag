Option Explicit

Sub GeneratePPTsPerDirector()
    Dim wsPipeline As Worksheet
    Set wsPipeline = ThisWorkbook.Sheets("New Plan Pipeline")

    Dim wsHelper As Worksheet
    On Error Resume Next
    Set wsHelper = ThisWorkbook.Sheets("Helper")
    On Error GoTo 0
    
    ' Create hidden "Helper" if it doesn't already exist
    If wsHelper Is Nothing Then
        Set wsHelper = ThisWorkbook.Worksheets.Add
        wsHelper.Name = "Helper"
        wsHelper.Visible = xlSheetHidden
    End If
    
    Dim lastRow As Long
    lastRow = wsPipeline.Cells(wsPipeline.Rows.Count, "A").End(xlUp).Row
    
    ' Gather unique directors
    Dim dictDirs As Object
    Set dictDirs = CreateObject("Scripting.Dictionary")
    
    Dim i As Long, dirName As String
    For i = 2 To lastRow
        dirName = Trim(wsPipeline.Cells(i, "B").Value)
        If dirName <> "" Then
            If Not dictDirs.Exists(dirName) Then dictDirs.Add dirName, dirName
        End If
    Next i
    
    Dim tcXlAddIn As Object
    Set tcXlAddIn = Application.COMAddIns("thinkcell.addin").Object
    
    Dim ppApp As PowerPoint.Application
    Set ppApp = New PowerPoint.Application
    
    ' Adjust stage labels to match your data
    Dim stageLabels As Variant
    stageLabels = Array("Stage 1", "Stage 2", "Stage 3", "Stage 4")
    
    Dim director As Variant
    For Each director In dictDirs.Keys
        Dim countStages(1 To 4) As Long
        
        ' Count deals by stage for this director
        For i = 2 To lastRow
            If Trim(wsPipeline.Cells(i, "B").Value) = director Then
                Select Case Trim(wsPipeline.Cells(i, "E").Value)
                    Case "Stage 1": countStages(1) = countStages(1) + 1
                    Case "Stage 2": countStages(2) = countStages(2) + 1
                    Case "Stage 3": countStages(3) = countStages(3) + 1
                    Case "Stage 4": countStages(4) = countStages(4) + 1
                End Select
            End If
        Next i
        
        ' Place labels in B1:E1 and counts in B3:E3 on "Helper"
        With wsHelper
            .Range("B1").Value = stageLabels(0)
            .Range("C1").Value = stageLabels(1)
            .Range("D1").Value = stageLabels(2)
            .Range("E1").Value = stageLabels(3)
            
            .Range("B3").Value = countStages(1)
            .Range("C3").Value = countStages(2)
            .Range("D3").Value = countStages(3)
            .Range("E3").Value = countStages(4)
        End With
        
        ' Open template invisibly
        Dim pres As PowerPoint.Presentation
        Set pres = ppApp.Presentations.Open( _
            Filename:="C:\TemplateFolder\template1.pptx", _
            WithWindow:=msoFalse)
        
        ' Update the chart on slide 2
        Dim rngData As Range
        Set rngData = wsHelper.Range("B1:E3")
        tcXlAddIn.UpdateChart pres.Slides(2), "Chart1", rngData, False
        
        ' Save and close
        pres.SaveAs "C:\OutputPPTs\" & director & "_Pipeline.pptx"
        pres.Close
    Next director
    
    ppApp.Quit
    MsgBox "All PowerPoints generated successfully."
End Sub
