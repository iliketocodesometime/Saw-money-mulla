Option Explicit

Sub UpdateChartsForDirectors()
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim ws As Worksheet: Set ws = wb.Sheets("New Plan Pipeline")
    
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    ' Full range including header
    Dim rngAll As Range
    Set rngAll = ws.Range("A1:E" & lastRow)
    
    ' Build dictionary of unique directors in column B (rows 2+)
    Dim dictDir As Object: Set dictDir = CreateObject("Scripting.Dictionary")
    Dim i As Long
    For i = 2 To lastRow
        If Not IsEmpty(ws.Cells(i, 2).Value) Then
            If Not dictDir.Exists(ws.Cells(i, 2).Value) Then
                dictDir.Add ws.Cells(i, 2).Value, True
            End If
        End If
    Next i
    
    ' Think-Cell object
    Dim tcXlAddIn As Object
    Set tcXlAddIn = Application.COMAddIns("thinkcell.addin").Object
    
    ' PowerPoint
    Dim ppApp As Object
    Set ppApp = CreateObject("PowerPoint.Application")
    
    Const templatePath       As String = "C:\Samples\UpdateChart\template.pptx"
    Const saveFolder         As String = "C:\Samples\UpdateChart\"
    Const thinkCellChartName As String = "Chart1"
    
    Dim dirName As Variant, pres As Object, rngFilter As Range
    
    For Each dirName In dictDir.Keys
        ' Clear old filter, apply new filter
        ws.AutoFilterMode = False
        rngAll.AutoFilter Field:=2, Criteria1:=dirName
        
        On Error Resume Next
        Set rngFilter = rngAll.SpecialCells(xlCellTypeVisible)
        On Error GoTo 0
        
        If Not rngFilter Is Nothing Then
            ' Delete TempChartData if it exists
            On Error Resume Next
            Application.DisplayAlerts = False
            wb.Worksheets("TempChartData").Delete
            Application.DisplayAlerts = True
            On Error GoTo 0
            
            ' Create fresh TempChartData
            Dim wsTemp As Worksheet
            Set wsTemp = wb.Worksheets.Add
            wsTemp.Name = "TempChartData"
            
            ' Dictionary of Stage => count
            Dim dictStage As Object: Set dictStage = CreateObject("Scripting.Dictionary")
            
            Dim r As Range
            For Each r In rngFilter.Columns(5).Cells
                ' Skip header row
                If r.Row > 1 Then
                    If Not IsEmpty(r.Value) Then
                        If dictStage.Exists(r.Value) Then
                            dictStage(r.Value) = dictStage(r.Value) + 1
                        Else
                            dictStage.Add r.Value, 1
                        End If
                    End If
                End If
            Next r
            
            If dictStage.Count > 0 Then
                Dim colPtr As Long: colPtr = 2  ' Start in column B
                Dim key
                
                For Each key In dictStage.Keys
                    wsTemp.Cells(1, colPtr).Value = key
                    wsTemp.Cells(3, colPtr).Value = dictStage(key)
                    colPtr = colPtr + 1
                Next key
                
                Dim rngChart As Range
                Set rngChart = wsTemp.Range(wsTemp.Cells(1, 2), wsTemp.Cells(3, colPtr - 1))
                
                ' Open template read-only and update
                Set pres = ppApp.Presentations.Open(templatePath, , True)
                tcXlAddIn.UpdateChart pres, thinkCellChartName, rngChart, False
                
                ' Save & close
                pres.SaveAs saveFolder & dirName & "_updated.pptx"
                pres.Close
            End If
        End If
        ws.AutoFilterMode = False
    Next dirName
    
    ppApp.Quit
    MsgBox "All Director-specific presentations have been created."
End Sub
