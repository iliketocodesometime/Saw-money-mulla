'=== (m-1) Slide 5: TableReinvest with Q/Q and Y/Y additions ===
Dim wsSPD As Worksheet, wsSPDH As Worksheet
On Error Resume Next
Set wsSPD = ThisWorkbook.Sheets("SPD Revenue")
Set wsSPDH = ThisWorkbook.Sheets("SPD Revenue Historical")
On Error GoTo 0

If Not wsSPD Is Nothing And Not wsSPDH Is Nothing Then
    Dim colDirSPD As Long, colAcctSPD As Long, colDateSPD As Long
    Dim colAttrSPD As Long, colYTDSPD As Long

    colDirSPD = FindColumnIndex(wsSPD, "Director")
    colAcctSPD = FindColumnIndex(wsSPD, "KEY_ACCT_PRIMARY")
    colDateSPD = FindColumnIndex(wsSPD, "ALG_FUND_DATE")
    colAttrSPD = FindColumnIndex(wsSPD, "ATTRB")
    colYTDSPD = FindColumnIndex(wsSPD, "YTD_NNA")

    Dim colDirSPDH As Long, colAcctSPDH As Long, colDateSPDH As Long
    Dim colAttrSPDH As Long, colYTDSPDH As Long

    colDirSPDH = FindColumnIndex(wsSPDH, "Director")
    colAcctSPDH = FindColumnIndex(wsSPDH, "KEY_ACCT_PRIMARY")
    colDateSPDH = FindColumnIndex(wsSPDH, "ALG_FUND_DATE")
    colAttrSPDH = FindColumnIndex(wsSPDH, "ATTRB")
    colYTDSPDH = FindColumnIndex(wsSPDH, "YTD_NNA")

    If colDirSPD * colAcctSPD * colDateSPD * colAttrSPD * colYTDSPD = 0 _
       Or colDirSPDH * colAcctSPDH * colDateSPDH * colAttrSPDH * colYTDSPDH = 0 Then
        MsgBox "Missing columns in SPD Revenue or Historical sheet"
        Exit Sub
    End If

    ' Get latest ALG_FUND_DATE to determine current quarter
    Dim latestDate As Date
    latestDate = DateSerial(2000, 1, 1)
    Dim rowSPD As Long
    For rowSPD = 2 To wsSPD.Cells(wsSPD.Rows.Count, colDateSPD).End(xlUp).Row
        Dim rawDate As String: rawDate = Trim(wsSPD.Cells(rowSPD, colDateSPD).Value)
        If rawDate <> "" Then
            Dim d As Date
            On Error Resume Next
            d = CDate(Left(rawDate, 10))
            On Error GoTo 0
            If d > latestDate Then latestDate = d
        End If
    Next rowSPD

    Dim qtr As Long, yr As Long
    yr = Year(latestDate)
    qtr = Int((Month(latestDate) - 1) / 3) + 1

    Dim currentQ As String: currentQ = "Q" & qtr & " " & yr
    Dim prevQ As String
    Dim prevYr As Long, prevQtr As Long
    If qtr = 1 Then
        prevQtr = 4: prevYr = yr - 1
    Else
        prevQtr = qtr - 1: prevYr = yr
    End If
    prevQ = "Q" & prevQtr & " " & prevYr

    Dim lastYrQtr As String
    lastYrQtr = "Q" & qtr & " " & (yr - 1)

    ' --- Helper function inside block ---
    Function InQuarter(dt As Date, q As Long, y As Long) As Boolean
        InQuarter = (Year(dt) = y) And (Int((Month(dt) - 1) / 3) + 1 = q)
    End Function

    ' --- Counters ---
    Dim countNow As Long: countNow = 0
    Dim countPrev As Long: countPrev = 0
    Dim countLastYr As Long: countLastYr = 0
    Dim sumNow As Double: sumNow = 0
    Dim sumPrev As Double: sumPrev = 0
    Dim sumLastYr As Double: sumLastYr = 0

    ' --- Process SPD Revenue (this year) ---
    For rowSPD = 2 To wsSPD.Cells(wsSPD.Rows.Count, colAcctSPD).End(xlUp).Row
        If Trim(wsSPD.Cells(rowSPD, colDirSPD).Value) = director Then
            If UCase(Trim(wsSPD.Cells(rowSPD, colAttrSPD).Value)) = "DISTRIBUTED" Then
                Dim thisDateStr As String: thisDateStr = Trim(wsSPD.Cells(rowSPD, colDateSPD).Value)
                If thisDateStr <> "" Then
                    Dim thisDate As Date
                    On Error Resume Next
                    thisDate = CDate(Left(thisDateStr, 10))
                    On Error GoTo 0

                    If InQuarter(thisDate, qtr, yr) Then
                        countNow = countNow + 1
                        If IsNumeric(wsSPD.Cells(rowSPD, colYTDSPD).Value) Then
                            sumNow = sumNow + wsSPD.Cells(rowSPD, colYTDSPD).Value
                        End If
                    ElseIf InQuarter(thisDate, prevQtr, prevYr) Then
                        countPrev = countPrev + 1
                        If IsNumeric(wsSPD.Cells(rowSPD, colYTDSPD).Value) Then
                            sumPrev = sumPrev + wsSPD.Cells(rowSPD, colYTDSPD).Value
                        End If
                    End If
                End If
            End If
        End If
    Next rowSPD

    ' --- Process SPD Revenue Historical (last year) ---
    For rowSPD = 2 To wsSPDH.Cells(wsSPDH.Rows.Count, colAcctSPDH).End(xlUp).Row
        If Trim(wsSPDH.Cells(rowSPD, colDirSPDH).Value) = director Then
            If UCase(Trim(wsSPDH.Cells(rowSPD, colAttrSPDH).Value)) = "DISTRIBUTED" Then
                Dim histDateStr As String: histDateStr = Trim(wsSPDH.Cells(rowSPD, colDateSPDH).Value)
                If histDateStr <> "" Then
                    Dim histDate As Date
                    On Error Resume Next
                    histDate = CDate(Left(histDateStr, 10))
                    On Error GoTo 0

                    If InQuarter(histDate, qtr, yr - 1) Then
                        countLastYr = countLastYr + 1
                        If IsNumeric(wsSPDH.Cells(rowSPD, colYTDSPDH).Value) Then
                            sumLastYr = sumLastYr + wsSPDH.Cells(rowSPD, colYTDSPDH).Value
                        End If
                    End If
                End If
            End If
        End If
    Next rowSPD

    ' --- Output to TableReinvest ---
    Dim shpReinvest As PowerPoint.Shape
    On Error Resume Next
    Set shpReinvest = pres.Slides(5).Shapes("TableReinvest")
    On Error GoTo 0

    If Not shpReinvest Is Nothing Then
        With shpReinvest.Table
            .Cell(1, 3).Shape.TextFrame.TextRange.Text = currentQ
            .Cell(1, 4).Shape.TextFrame.TextRange.Text = prevQ
            .Cell(1, 5).Shape.TextFrame.TextRange.Text = "Q/Q Change"
            .Cell(1, 6).Shape.TextFrame.TextRange.Text = lastYrQtr

            .Cell(2, 3).Shape.TextFrame.TextRange.Text = countNow
            .Cell(3, 3).Shape.TextFrame.TextRange.Text = Format(sumNow, "$#,##0")

            .Cell(2, 4).Shape.TextFrame.TextRange.Text = countPrev
            .Cell(3, 4).Shape.TextFrame.TextRange.Text = Format(sumPrev, "$#,##0")

            If countPrev > 0 Then
                .Cell(2, 5).Shape.TextFrame.TextRange.Text = Format((countNow - countPrev) / countPrev, "0.0%")
            Else
                .Cell(2, 5).Shape.TextFrame.TextRange.Text = "N/A"
            End If

            If sumPrev > 0 Then
                .Cell(3, 5).Shape.TextFrame.TextRange.Text = Format((sumNow - sumPrev) / sumPrev, "0.0%")
            Else
                .Cell(3, 5).Shape.TextFrame.TextRange.Text = "N/A"
            End If

            .Cell(2, 6).Shape.TextFrame.TextRange.Text = countLastYr
            .Cell(3, 6).Shape.TextFrame.TextRange.Text = Format(sumLastYr, "$#,##0")

            .Cell(7, 1).Shape.TextFrame.TextRange.Text = "Y/Y Change"
            If countLastYr > 0 Then
                .Cell(7, 2).Shape.TextFrame.TextRange.Text = Format((countNow - countLastYr) / countLastYr, "0.0%")
            Else
                .Cell(7, 2).Shape.TextFrame.TextRange.Text = "N/A"
            End If
            If sumLastYr > 0 Then
                .Cell(7, 3).Shape.TextFrame.TextRange.Text = Format((sumNow - sumLastYr) / sumLastYr, "0.0%")
            Else
                .Cell(7, 3).Shape.TextFrame.TextRange.Text = "N/A"
            End If
        End With
    End If
End If

