import pandas as pd
import numpy as np

# Function to compute distance between two sets of latitudes and longitudes
def haversine(lon1, lat1, lon2, lat2):
    R = 6371.0  # Radius of the earth in kilometers
    lon1, lat1, lon2, lat2 = map(np.radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    a = np.sin(dlat/2)**2 + np.cos(lat1) * np.cos(lat2) * np.sin(dlon/2)**2
    c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1-a))
    distance = R * c
    return distance

# Original breakdown for ranked FAs and allocation for unranked FAs
original_breakdown = [100, 0, 0, 0, 0, 0]  # Example breakdown for ranked FAs
unranked_allocation = 90  # Allocation for unranked FAs

# Adjusting the breakdown to include unranked FAs
adjusted_breakdown = [b * (100 - unranked_allocation) / 100 for b in original_breakdown] + [unranked_allocation]

# Mark FAs as ranked or unranked based on the 'Rank' column
fa_full_info_df['Ranked'] = fa_full_info_df['Rank'].notna()

# Assign ranked FAs to bins
ranked_fas = fa_full_info_df[fa_full_info_df['Ranked']].copy()
# Filter out bins with 0% allocation before calculating bin limits
non_zero_bins = [b for b in adjusted_breakdown[:-1] if b > 0]
cumulative_breakdown = np.cumsum(non_zero_bins)
bin_limits = len(ranked_fas) * np.array(cumulative_breakdown) / 100
ranked_fas['Bin'] = np.digitize(range(len(ranked_fas)), bin_limits, right=False) + 1

# Assign unranked FAs to the last bin
unranked_fas = fa_full_info_df[~fa_full_info_df['Ranked']].copy()
unranked_fas['Bin'] = len(adjusted_breakdown)  # Last bin for unranked FAs

# Combine ranked and unranked FAs
fa_full_info_df = pd.concat([ranked_fas, unranked_fas])

# Calculate the number of leads to distribute to each bin
total_leads = len(leads_with_geo_good_df)
max_leads_per_bin = {i+1: total_leads * pct / 100 for i, pct in enumerate(adjusted_breakdown)}

# Initialize the count of leads assigned per bin
leads_assigned_per_bin = {i: 0 for i in range(1, len(adjusted_breakdown)+1)}

# Lead assignment loop
for index, lead_row in leads_with_geo_good_df.iterrows():
    for bin_num in
