Dim colDirWBPipe As Long, colStageWBPipe As Long
colDirWBPipe = FindColumnIndex(wsWBPipe, "Director")
colStageWBPipe = FindColumnIndex(wsWBPipe, "Stage")

If colDirWBPipe = 0 Or colStageWBPipe = 0 Then
    MsgBox "Missing columns in 'Workplace Banking Pipeline'"
    Exit Sub
End If


'=== (l5) Slide 4: ThinkCell "DeepPipe" (Workplace Banking Pipeline, per Director, 4-stage) ===
If Not wsWBPipe Is Nothing And Not tcXlAddIn Is Nothing Then
    Dim colDirWBPipe As Long, colStageWBPipe As Long
    colDirWBPipe = FindColumnIndex(wsWBPipe, "Director")
    colStageWBPipe = FindColumnIndex(wsWBPipe, "Stage")

    If colDirWBPipe = 0 Or colStageWBPipe = 0 Then
        MsgBox "Missing columns in 'Workplace Banking Pipeline'"
        Exit Sub
    End If

    Dim stageLabelsDeep As Variant
    stageLabelsDeep = Array("Active Pursuit", "Shortlisted / Decision Pending", "Verbal Agreement", "Contract Negotiation")

    Dim deepPipeCounts(1 To 4) As Long
    Dim rDeep As Long
    For rDeep = 1 To 4: deepPipeCounts(rDeep) = 0: Next rDeep

    Dim rowWB As Long
    For rowWB = 2 To wsWBPipe.Cells(wsWBPipe.Rows.Count, 1).End(xlUp).Row
        If Trim(wsWBPipe.Cells(rowWB, colDirWBPipe).Value) = director Then
            Dim stageDeep As String
            stageDeep = Trim(wsWBPipe.Cells(rowWB, colStageWBPipe).Value)
            For rDeep = 0 To 3
                If stageDeep = stageLabelsDeep(rDeep) Then
                    deepPipeCounts(rDeep + 1) = deepPipeCounts(rDeep + 1) + 1
                    Exit For
                End If
            Next rDeep
        End If
    Next rowWB

    With wsHelper
        .Range("A1:B6").ClearContents
        .Range("A1").Value = "Deepening Pipeline"
        .Range("B1").Value = director
        .Range("A3").Value = "Active Pursuit"
        .Range("A4").Value = "Shortlisted / Decision Pending"
        .Range("A5").Value = "Verbal Agreement"
        .Range("A6").Value = "Contract Negotiation"

        For rDeep = 1 To 4
            .Cells(rDeep + 2, 2).Value = BlankIfZero(deepPipeCounts(rDeep))
        Next rDeep
    End With

    Dim rngDeepPipe As Range
    Set rngDeepPipe = wsHelper.Range("A1:B6")
    tcXlAddIn.UpdateChart pres.Slides(4), "DeepPipe", rngDeepPipe, False
End If
