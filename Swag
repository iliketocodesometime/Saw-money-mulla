Dim wsUpsellPipeline As Worksheet
Set wsUpsellPipeline = ThisWorkbook.Sheets("Upsell Pipeline")

Dim colDirUpsellPipe As Long, colLineUpsellPipe As Long, colStageUpsellPipe As Long
colDirUpsellPipe = FindColumnIndex(wsUpsellPipeline, "Director")
colLineUpsellPipe = FindColumnIndex(wsUpsellPipeline, "GAS Business Line")
colStageUpsellPipe = FindColumnIndex(wsUpsellPipeline, "Stage")

If colDirUpsellPipe = 0 Or colLineUpsellPipe = 0 Or colStageUpsellPipe = 0 Then
    MsgBox "Missing columns in 'Upsell Pipeline' tab"
    Exit Sub
End If


'=== (l2) Slide 4: ThinkCell "Chart 126" (Upsell Pipeline: 6x4 layout) ===
If Not wsUpsellPipeline Is Nothing And Not tcXlAddIn Is Nothing Then
    Dim upsellStages As Variant
    upsellStages = Array("Active Pursuit", "Shortlisted / Decision Pending", "Verbal Agreement", "Contract Negotiation")

    Dim upsellCounts(1 To 4, 1 To 3) As Long
    Dim ur As Long, uc As Long
    For ur = 1 To 4: For uc = 1 To 3: upsellCounts(ur, uc) = 0: Next uc: Next ur

    Dim lastRowUpsell As Long
    lastRowUpsell = wsUpsellPipeline.Cells(wsUpsellPipeline.Rows.Count, 1).End(xlUp).Row

    For iRow = 2 To lastRowUpsell
        If Trim(wsUpsellPipeline.Cells(iRow, colDirUpsellPipe).Value) = director Then
            Dim upsStage As String: upsStage = Trim(wsUpsellPipeline.Cells(iRow, colStageUpsellPipe).Value)
            Dim upsLine As String: upsLine = Trim(wsUpsellPipeline.Cells(iRow, colLineUpsellPipe).Value)

            Dim upsStageIdx As Long: upsStageIdx = MatchStageIndex(upsStage, upsellStages)
            Dim upsLineIdx As Long: upsLineIdx = MatchGASIndex(upsLine, arrGAS)
            If upsStageIdx > 0 And upsLineIdx > 0 Then
                upsellCounts(upsStageIdx, upsLineIdx) = upsellCounts(upsStageIdx, upsLineIdx) + 1
            End If
        End If
    Next iRow

    With wsHelper
        .Range("A1:D6").ClearContents
        .Range("A1").Value = "Upsell Pipeline"
        .Range("B1").Value = "Advanced Solutions"
        .Range("C1").Value = "Financial Reporting"
        .Range("D1").Value = "Global Intelligence"

        .Range("A2").Value = "" ' static, don't write
        .Range("A3").Value = "Active Pursuit"
        .Range("A4").Value = "Shortlisted / Decision Pending"
        .Range("A5").Value = "Verbal Agreement"
        .Range("A6").Value = "Contract Negotiation"

        For ur = 1 To 4
            For uc = 1 To 3
                .Cells(ur + 2, uc + 1).Value = BlankIfZero(upsellCounts(ur, uc))
            Next uc
        Next ur
    End With

    Dim rngUpsell As Range
    Set rngUpsell = wsHelper.Range("A1:D6")
    tcXlAddIn.UpdateChart pres.Slides(4), "Chart 126", rngUpsell, False
End If
