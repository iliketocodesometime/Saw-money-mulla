Sub GenerateDirectorPresentations()

    Dim ws As Worksheet
    Dim PPTApp As PowerPoint.Application
    Dim PPTPres As PowerPoint.Presentation
    Dim PPTSlide As PowerPoint.Slide
    Dim DirectorRange As Range, DirectorCell As Range
    Dim DataRange As Range
    Dim LastRow As Long
    Dim Director As String
    
    '--- Set worksheet and find last row ---
    Set ws = ThisWorkbook.Worksheets("New Plan Pipeline")
    LastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    '--- Define the DirectorRange (unique directors) ---
    ws.Range("B1:B" & LastRow).AdvancedFilter Action:=xlFilterCopy, _
        CopyToRange:=ws.Range("Z1"), Unique:=True
    Set DirectorRange = ws.Range("Z2:Z" & ws.Range("Z" & ws.Rows.Count).End(xlUp).Row)
    
    '--- Loop through each Director ---
    For Each DirectorCell In DirectorRange
        Director = DirectorCell.Value
        
        '--- Open template presentation ---
        Set PPTApp = New PowerPoint.Application
        PPTApp.Visible = True
        Set PPTPres = PPTApp.Presentations.Open("C:\Path\To\Template.pptx")
        Set PPTSlide = PPTPres.Slides(2) ' Slide with thinkcell chart
        
        '--- Build data range for this Director ---
        '   Example: we count each row that has this Director
        '   For Thinkcell, we typically provide a small table with category + values
        '   Here weâ€™ll set categories as distinct stages and counts as total occurrences.
        
        Dim StageDict As Object, c As Range
        Set StageDict = CreateObject("Scripting.Dictionary")
        
        For Each c In ws.Range("B2:B" & LastRow)
            If c.Value = Director Then
                ' The Stage is in column E, for example
                If Not StageDict.Exists(ws.Cells(c.Row, "E").Value) Then
                    StageDict.Add ws.Cells(c.Row, "E").Value, 1
                Else
                    StageDict(ws.Cells(c.Row, "E").Value) = StageDict(ws.Cells(c.Row, "E").Value) + 1
                End If
            End If
        Next c
        
        '--- Write small table for thinkcell link ---
        '   Let's place it on a hidden sheet or range
        With ws
            .Range("AA1").Value = "Stage"
            .Range("AB1").Value = "Count"
            Dim i As Long: i = 2
            
            Dim key As Variant
            For Each key In StageDict.Keys
                .Range("AA" & i).Value = key
                .Range("AB" & i).Value = StageDict(key)
                i = i + 1
            Next key
        End With

        '--- Update thinkcell chart link ---
        '   Assume the chart is set to read from "AA1:AB?":
        PPTSlide.Select
        PPTSlide.Shapes("Chart1").LinkFormat.Update ' if your link is properly set
        
        '--- Save new PPT ---
        PPTPres.SaveAs "C:\Path\To\Output\" & Director & " New Plan Sales.pptx"
        PPTPres.Close
        PPTApp.Quit
        
        '--- Clear out stage table for next iteration ---
        ws.Range("AA:AB").Clear
    Next DirectorCell
    
    '--- Cleanup ---
    ws.Range("Z:Z").ClearContents
    MsgBox "Presentations generated successfully."

End Sub
